# 「試験項目」シート変更反映アプリ（Patch適用）仕様書（Claude Code向け）v2

対象: アップロードされたExcelの **「試験項目」シート** に対して、
- 既存行の更新（指定列のみ更新）
- 新規行の追加（特定 Test ID の直後へ挿入）
- No. 自動採番（ひとまず）
を行う。  

このExcelの「試験項目」シートには、`No.` / `Test ID` / `Test Title` / `前提条件` / `試験手順` / `判定基準` / `KC備考` / `SB備考` / `MR組合せ` / `注意事項` 等の列が存在し、
一部に「自動入力」やモデル別（EB1190 等）列がある。これらは数式/集計を壊す恐れがあるため原則上書きしない。  

---

## 1. 決定事項（ユーザー回答反映）
- 行キー: **Test ID のみで一意**
- 新規行の挿入位置: **特定 Test ID の直後**
- No.: **自動採番（デフォルトON）**
- 自動入力列: **上書き不要（上書き禁止）**

---

## 2. 入出力

### 2.1 入力
1. `--base` : 変更対象のExcel（.xlsx）
2. `--patch` : 変更指示ファイル（推奨: YAML / JSON）
3. `--sheet` : 対象シート名（デフォルト `試験項目`）

### 2.2 出力
1. `--output` : 更新済みExcel（.xlsx）
2. `--report` : 差分レポート（.md）

---

## 3. Patch（変更指示）フォーマット

### 3.1 YAML例（推奨）
```yaml
sheet: "試験項目"
key_columns: ["Test ID"]
operations:
  - op: update
    key:
      Test ID: "OTR-MA-LQC-999.002.001"
    set:
      試験手順: |
        ＜準備＞
        ① ...
      判定基準: |
        ・エラーなくGOTAできること
      注意事項: |
        【注意】...

  - op: insert
    after_key:
      Test ID: "OTR-MA-LQC-999.002.002"   # ←この直後に挿入
    row:
      Test ID: "OTR-MA-LQC-999.002.003"
      Section: "FinalTest - Software Update(FOTA/GOTA)"
      Sub-section: "n-1 -> n"
      Test Title: "..."
      前提条件: "..."
      試験手順: "..."
      判定基準: "..."
      MR組合せ: "前回MR⇒最新MR"
      注意事項: "..."
```

### 3.2 ルール
- `op=update`: 既存行を `Test ID` で特定し、`set` にある列のみ上書き
- `op=insert`: `after_key.Test ID` の行の直後に1行追加
- patch内の列名は **Excelのヘッダ名と一致**させる（列はヘッダ名で探索）

---

## 4. 対象列（更新可能列）と禁止列

### 4.1 更新可能列（例）
- `Section`, `Sub-section`, `Test Title`, `前提条件`, `試験手順`, `判定基準`, `KC備考`, `SB備考`, `スクショ`, `MR組合せ`, `注意事項`

### 4.2 上書き禁止（原則）
- ヘッダに以下を含む列
  - `自動入力`
  - `TestNo`
  - `TestIDの試験数`
  - モデル名列（例: `EB1190`, `EB1209`, `EB1146`, ...）
- これらは update では変更しない。
- insert では「テンプレ行複製」により数式/書式を保持する。

---

## 5. 追加（insert）時の行生成

### 5.1 追加行の作り方
- 挿入位置（after_key の行）の **直下に1行挿入**
- 直上（after_key 行）を **テンプレ行として複製**し、
  - 罫線/フォント/塗り/配置/行高
  - 数式（自動入力列）
  - データ検証（あれば）
  を保持する
- その後、patch の `row` で指定された列だけ値を設定する

---

## 6. No. 自動採番

### 6.1 採番方針（デフォルト）
- データ領域（ヘッダ直下〜末尾）を上から走査し、
  - `Test ID` が空でない行のみを採番対象
  - `No.` を 1,2,3… で振り直す

### 6.2 末尾判定
- `Test ID` 列の連続空行が一定数（例: 3）続いたらデータ終端とみなす

---

## 7. ヘッダ行検出と列マッピング
- 1〜200行を走査し、同一行に `No.` と `Test ID` と `Test Title` が存在する行をヘッダとみなす
- ヘッダ行から「ヘッダ名→列番号」辞書を作成

---

## 8. 差分レポート（Markdown）
- 追加: 挿入位置（after_key Test ID）、新規 Test ID、主要列の要約
- 更新: Test ID、列名、旧→新（長文は先頭N文字+省略）

---

## 9. CLI（案）
```bash
patcher \
  --base "input/master.xlsx" \
  --patch "input/patch.yml" \
  --sheet "試験項目" \
  --output "out/master_updated.xlsx" \
  --report "out/diff.md"
```

オプション:
- `--dry-run`（Excelは出力せずdiffのみ）
- `--strict / --lenient`
- `--end-empty-rows 3`（終端判定の空行数）

---

## 10. 「入力元ファイルのサンプル」は必要？

### 10.1 Patch適用アプリ（本仕様）のみなら
- **必須ではありません。**
- 必要なのは「どの Test ID をどう更新/追加するか」という **patch.yml/json** です。

### 10.2 英語→日本語化まで自動生成したいなら
- **必要です。**
- 英語試験票の形式（Word/Excel/Markdown/PDF）によって、
  - 試験ケースの区切り
  - 見出しの取り方
  - 手順/判定基準の抽出方法
  が変わるため、最低1〜2ケースのサンプルがあると安定します。

---

## 11. 次に欲しいもの（最短で実装するため）
1) patchの入力方式を決めたいです：
- (A) あなたが patch.yml を作る（最短）
- (B) 英語試験票からこちらが patch.yml を自動生成する（拡張）

2) insert の複数件対応：
- 1つの after_key の直後に複数行を入れる可能性はありますか？（順序はpatch記載順でOK？）
